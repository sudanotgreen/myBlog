import{_ as n,o as s,c as a,b as t}from"./app--ias0FLC.js";const p="/myBlog/assets/appRecovery-qEAaPoKJ.png",o={},e=t(`<h1 id="应用恢复" tabindex="-1"><a class="header-anchor" href="#应用恢复" aria-hidden="true">#</a> 应用恢复</h1><p>鸿蒙应用恢复主要涉及 app_recovery 以及 ability_recovery 两个类。</p><h2 id="app-recovery-应用恢复类简介" tabindex="-1"><a class="header-anchor" href="#app-recovery-应用恢复类简介" aria-hidden="true">#</a> app_recovery 应用恢复类简介</h2><ol><li>在main_thread.cpp的 HandleLaunchApplication 方法中初始化app信息，使用单例模式使得每个app有且仅持有一个 app_recovery 实例。 app_recovery 实例会持有相应的app信息以及该 app 的 MainHandler （提供postTask的能力）。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isStageBased<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InitApplicationInfo</span><span class="token punctuation">(</span><span class="token function">GetMainHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>在 app_recovery 中持有一个 abilityRecoverys_ 属性和 AppRecovery::AddAbility 方法，用以储存各个 ability 的abilityRecovery 。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">AddAbility</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AbilityRuntime<span class="token double-colon punctuation">::</span>UIAbility<span class="token operator">&gt;</span> ability<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AbilityInfo<span class="token operator">&gt;</span><span class="token operator">&amp;</span> abilityInfo<span class="token punctuation">,</span> <span class="token keyword">const</span> sptr<span class="token operator">&lt;</span>IRemoteObject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> token<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 是否开启app恢复，未开启则无需存储</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isEnable_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery not enabled.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// abilityRecoverys_不为空，但ability未开启恢复返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abilityRecoverys_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>abilityInfo<span class="token operator">-&gt;</span>recoverable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery abilityRecoverys is not empty but ability recoverable is false.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建并添加 abilityRecovery</span>
    ability_ <span class="token operator">=</span> ability<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AbilityRecovery<span class="token operator">&gt;</span> abilityRecovery <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AbilityRecovery<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    abilityRecovery<span class="token operator">-&gt;</span><span class="token function">InitAbilityInfo</span><span class="token punctuation">(</span>ability<span class="token punctuation">,</span> abilityInfo<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    abilityRecovery<span class="token operator">-&gt;</span><span class="token function">EnableAbilityRecovery</span><span class="token punctuation">(</span>restartFlag_<span class="token punctuation">,</span> saveOccasion_<span class="token punctuation">,</span> saveMode_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将ability与abilityRecovery一一绑定</span>
    ability<span class="token operator">-&gt;</span><span class="token function">EnableAbilityRecovery</span><span class="token punctuation">(</span>abilityRecovery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    abilityRecoverys_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>abilityRecovery<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除历史失效储存文件</span>
    <span class="token keyword">auto</span> handler <span class="token operator">=</span> mainHandler_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> task <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DeleteInValidMissionFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token operator">-&gt;</span><span class="token function">PostTask</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery:AddAbility&quot;</span><span class="token punctuation">,</span> DELAY_TIME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;Failed to DeleteInValidMissionFiles.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 JsUIAbility::Init 方法中会调用该方法进行注册。 相应的也有清除的方法，会在 main_thread 执行 MainThread::HandleCleanAbility 时进行清理。</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>abilityInfo<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AbilityType<span class="token double-colon punctuation">::</span>PAGE <span class="token operator">&amp;&amp;</span> abilityInfo<span class="token operator">-&gt;</span>isStageBasedModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RemoveAbility</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ability-recovery-元能力恢复类简介" tabindex="-1"><a class="header-anchor" href="#ability-recovery-元能力恢复类简介" aria-hidden="true">#</a> ability_recovery 元能力恢复类简介</h2><ol><li>AbilityRecovery::InitAbilityInfo 方法在上文 AppRecovery::AddAbility 时调用。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">AbilityRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">InitAbilityInfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AbilityRuntime<span class="token double-colon punctuation">::</span>UIAbility<span class="token operator">&gt;</span> ability<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AbilityInfo<span class="token operator">&gt;</span><span class="token operator">&amp;</span> abilityInfo<span class="token punctuation">,</span> <span class="token keyword">const</span> sptr<span class="token operator">&lt;</span>IRemoteObject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> token<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ability_recovery 储存的核心信息</span>
    isEnable_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    ability_ <span class="token operator">=</span> ability<span class="token punctuation">;</span>
    abilityInfo_ <span class="token operator">=</span> abilityInfo<span class="token punctuation">;</span>
    token_ <span class="token operator">=</span> token<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> abilityContext <span class="token operator">=</span> ability<span class="token operator">-&gt;</span><span class="token function">GetAbilityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityContext <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        abilityContext<span class="token operator">-&gt;</span><span class="token function">GetMissionId</span><span class="token punctuation">(</span>missionId_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">TAG_LOGI</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery InitAbilityInfo, missionId_:%{public}d&quot;</span><span class="token punctuation">,</span> missionId_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>恢复模式的设置方法</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">AbilityRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">EnableAbilityRecovery</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> restartFlag<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> saveFlag<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> saveMode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    isEnable_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    restartFlag_ <span class="token operator">=</span> restartFlag<span class="token punctuation">;</span>
    saveOccasion_ <span class="token operator">=</span> saveFlag<span class="token punctuation">;</span>
    saveMode_ <span class="token operator">=</span> saveMode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="app恢复信息储存流程" tabindex="-1"><a class="header-anchor" href="#app恢复信息储存流程" aria-hidden="true">#</a> app恢复信息储存流程</h2><p><img src="`+p+`" alt="恢复信息储存"></p><ol><li>图中 AppRecovery::DoSaveAppState 会判断是否只储存单个 ability 的信息，否则循环储存每一个的信息。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">DoSaveAppState</span><span class="token punctuation">(</span>StateReason reason<span class="token punctuation">,</span> uintptr_t ability<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery DoSaveAppState begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> appInfo <span class="token operator">=</span> applicationInfo_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appInfo <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> abilityRecoverys_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery Application or ability info is not exist.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> onlySaveTargetAbility <span class="token operator">=</span> <span class="token punctuation">(</span>ability <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> abilityRecoveryRecord <span class="token operator">:</span> abilityRecoverys_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlySaveTargetAbility<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            abilityRecoveryRecord<span class="token operator">-&gt;</span><span class="token function">ScheduleSaveAbilityState</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery not onlySaveTargetAbility ScheduleSaveAbilityState&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityRecoveryRecord<span class="token operator">-&gt;</span><span class="token function">IsSameAbility</span><span class="token punctuation">(</span>ability<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            abilityRecoveryRecord<span class="token operator">-&gt;</span><span class="token function">ScheduleSaveAbilityState</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery IsSameAbility ScheduleSaveAbilityState&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>图中 AbilityRecovery::SaveAbilityState 中， 会根据用户储存地区的设置，选择是否写成文件还是只存在 AbilityRecovery 实例中。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>saveMode_ <span class="token operator">==</span> SaveModeFlag<span class="token double-colon punctuation">::</span>SAVE_WITH_FILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SerializeDataToFile</span><span class="token punctuation">(</span>missionId_<span class="token punctuation">,</span> wantParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>saveMode_ <span class="token operator">==</span> SaveModeFlag<span class="token double-colon punctuation">::</span>SAVE_WITH_SHARED_MEMORY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    params_ <span class="token operator">=</span> wantParams<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="app恢复流程" tabindex="-1"><a class="header-anchor" href="#app恢复流程" aria-hidden="true">#</a> app恢复流程</h2><ol><li>判断是否是应用freeze导致的，从而决定由谁来执行app的回复重启</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleRecoverApp</span><span class="token punctuation">(</span>StateReason reason<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isEnable_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery ScheduleRecoverApp. is not enabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ShouldRecoverApp</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery ScheduleRecoverApp. is not recover app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityRecoverys_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery ScheduleRecoverApp ability is nullptr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> StateReason<span class="token double-colon punctuation">::</span>APP_FREEZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DoRecoverApp</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> handler <span class="token operator">=</span> mainHandler_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery ScheduleRecoverApp main handler is not exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> task <span class="token operator">=</span> <span class="token punctuation">[</span>reason<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DoRecoverApp</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token operator">-&gt;</span><span class="token function">PostTask</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery:RecoverApp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;Failed to schedule save app state.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>寻找当前处于前台的 ability 并调用其恢复方法。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">AppRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">DoRecoverApp</span><span class="token punctuation">(</span>StateReason reason<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery DoRecoverApp begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityRecoverys_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery no ability exist! &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    AAFwk<span class="token double-colon punctuation">::</span>Want <span class="token operator">*</span>want <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>want_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        want <span class="token operator">=</span> want_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityRecoverys_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityRecoverys_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">IsOnForeground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            abilityRecoverys_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ScheduleRecoverAbility</span><span class="token punctuation">(</span>reason<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> itr <span class="token operator">=</span> abilityRecoverys_<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> itr <span class="token operator">!=</span> abilityRecoverys_<span class="token punctuation">.</span><span class="token function">rend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> itr<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>itr<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">IsOnForeground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>itr<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ScheduleRecoverAbility</span><span class="token punctuation">(</span>reason<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">TAG_LOGW</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery no foreground ability, not DoRecoverApp!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>判断是否开启 ability 的恢复，是否存在可用的 abilityMgr ，发起 ability 恢复流程</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">AbilityRecovery</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleRecoverAbility</span><span class="token punctuation">(</span>StateReason reason<span class="token punctuation">,</span> <span class="token keyword">const</span> Want <span class="token operator">*</span>want<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isEnable_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery not enable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AAFwk<span class="token double-colon punctuation">::</span>AbilityManagerClient<span class="token operator">&gt;</span> abilityMgr <span class="token operator">=</span> AAFwk<span class="token double-colon punctuation">::</span><span class="token class-name">AbilityManagerClient</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>abilityMgr <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>RECOVERY<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery ScheduleRecoverApp. abilityMgr client is not exist.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> token <span class="token operator">=</span> token_<span class="token punctuation">.</span><span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    abilityMgr<span class="token operator">-&gt;</span><span class="token function">ScheduleRecoverAbility</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>校验是否频繁重启，target ability 的类型是否是 PAGE，最后重设want，正式发起重启。</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">AbilityManagerService</span><span class="token double-colon punctuation">::</span><span class="token function">ScheduleRecoverAbility</span><span class="token punctuation">(</span><span class="token keyword">const</span> sptr<span class="token operator">&lt;</span>IRemoteObject<span class="token operator">&gt;</span><span class="token operator">&amp;</span> token<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> reason<span class="token punctuation">,</span> <span class="token keyword">const</span> Want <span class="token operator">*</span>want<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> record <span class="token operator">=</span> <span class="token class-name">Token</span><span class="token double-colon punctuation">::</span><span class="token function">GetAbilityRecordByToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;%{public}s AppRecovery::failed find abilityRecord by given token.&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token operator">-&gt;</span><span class="token function">IsForeground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>record<span class="token operator">-&gt;</span><span class="token function">GetAbilityForegroundingFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;%{public}s AppRecovery::failed to recoveryAbility.&quot;</span>
            <span class="token string">&quot;due to it is background&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> callingTokenId <span class="token operator">=</span> <span class="token class-name">IPCSkeleton</span><span class="token double-colon punctuation">::</span><span class="token function">GetCallingTokenID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> tokenID <span class="token operator">=</span> record<span class="token operator">-&gt;</span><span class="token function">GetApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>accessTokenId<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callingTokenId <span class="token operator">!=</span> tokenID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery ScheduleRecoverAbility not self, not enabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    AAFwk<span class="token double-colon punctuation">::</span>Want curWant<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>ffrt<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>globalLock_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> type <span class="token operator">=</span> record<span class="token operator">-&gt;</span><span class="token function">GetAbilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> AppExecFwk<span class="token double-colon punctuation">::</span>AbilityType<span class="token double-colon punctuation">::</span>PAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;%{public}s AppRecovery::only do recover for page ability.&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> MIN_RECOVERY_TIME <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
        <span class="token keyword">int64_t</span> now <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> it <span class="token operator">=</span> appRecoveryHistory_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> appInfo <span class="token operator">=</span> record<span class="token operator">-&gt;</span><span class="token function">GetApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> abilityInfo <span class="token operator">=</span> record<span class="token operator">-&gt;</span><span class="token function">GetAbilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>it <span class="token operator">!=</span> appRecoveryHistory_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>it<span class="token operator">-&gt;</span>second <span class="token operator">+</span> MIN_RECOVERY_TIME <span class="token operator">&gt;</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span>
                <span class="token string">&quot;%{public}s AppRecovery recover app more than once in one minute, just kill app(%{public}d).&quot;</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">,</span> record<span class="token operator">-&gt;</span><span class="token function">GetPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">ReportAppRecoverResult</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> abilityInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;FAIL_WITHIN_ONE_MINUTE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">AppRecoverKill</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>want <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;BundleName:%{public}s targetBundleName:%{public}s.&quot;</span><span class="token punctuation">,</span>
                appInfo<span class="token punctuation">.</span>bundleName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> want<span class="token operator">-&gt;</span><span class="token function">GetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetBundleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>want<span class="token operator">-&gt;</span><span class="token function">GetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetBundleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>bundleName<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>want<span class="token operator">-&gt;</span><span class="token function">GetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetBundleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery BundleName not match, Not recovery ability!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ReportAppRecoverResult</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> abilityInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;FAIL_BUNDLE_NAME_NOT_MATCH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>want<span class="token operator">-&gt;</span><span class="token function">GetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAbilityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery recovery target ability is empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ReportAppRecoverResult</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> abilityInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;FAIL_TARGET_ABILITY_EMPTY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">auto</span> bms <span class="token operator">=</span> <span class="token function">GetBundleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bms <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;bms is nullptr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                AppExecFwk<span class="token double-colon punctuation">::</span>BundleInfo bundleInfo<span class="token punctuation">;</span>
                <span class="token keyword">auto</span> bundleName <span class="token operator">=</span> want<span class="token operator">-&gt;</span><span class="token function">GetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetBundleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int32_t</span> userId <span class="token operator">=</span> <span class="token function">GetUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">bool</span> ret <span class="token operator">=</span> <span class="token function">IN_PROCESS_CALL</span><span class="token punctuation">(</span>
                    bms<span class="token operator">-&gt;</span><span class="token function">GetBundleInfo</span><span class="token punctuation">(</span>bundleName<span class="token punctuation">,</span> AppExecFwk<span class="token double-colon punctuation">::</span>BundleFlag<span class="token double-colon punctuation">::</span>GET_BUNDLE_WITH_ABILITIES<span class="token punctuation">,</span> bundleInfo<span class="token punctuation">,</span>
                    userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery Failed to get bundle info, not do recovery!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">bool</span> isRestartPage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> abilityName <span class="token operator">=</span> want<span class="token operator">-&gt;</span><span class="token function">GetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetAbilityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> bundleInfo<span class="token punctuation">.</span>abilityInfos<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> bundleInfo<span class="token punctuation">.</span>abilityInfos<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>abilityName<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>it<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> it<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AppExecFwk<span class="token double-colon punctuation">::</span>AbilityType<span class="token double-colon punctuation">::</span>PAGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        isRestartPage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRestartPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">TAG_LOGI</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>ABILITYMGR<span class="token punctuation">,</span> <span class="token string">&quot;AppRecovery the target ability type is not PAGE!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">ReportAppRecoverResult</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> abilityName<span class="token punctuation">,</span> <span class="token string">&quot;FAIL_TARGET_ABILITY_NOT_PAGE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        appRecoveryHistory_<span class="token punctuation">[</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">;</span>
        curWant <span class="token operator">=</span> <span class="token punctuation">(</span>want <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">?</span> record<span class="token operator">-&gt;</span><span class="token function">GetWant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">*</span>want<span class="token punctuation">;</span>
        curWant<span class="token punctuation">.</span><span class="token function">SetParam</span><span class="token punctuation">(</span>AAFwk<span class="token double-colon punctuation">::</span>Want<span class="token double-colon punctuation">::</span>PARAM_ABILITY_RECOVERY_RESTART<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">ReportAppRecoverResult</span><span class="token punctuation">(</span>record<span class="token operator">-&gt;</span><span class="token function">GetUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span> abilityInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">RestartApp</span><span class="token punctuation">(</span>curWant<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>在ability启动过程中判断是否是重启导致的启动，从而去读取内容</li></ol><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token class-name">JsUIAbility</span><span class="token double-colon punctuation">::</span><span class="token function">AbilityContinuationOrRecover</span><span class="token punctuation">(</span><span class="token keyword">const</span> Want <span class="token operator">&amp;</span>want<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">HITRACE_METER_NAME</span><span class="token punctuation">(</span>HITRACE_TAG_ABILITY_MANAGER<span class="token punctuation">,</span> __PRETTY_FUNCTION__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// multi-instance ability continuation</span>
    <span class="token function">TAG_LOGD</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>UIABILITY<span class="token punctuation">,</span> <span class="token string">&quot;Launch reason is %{public}d.&quot;</span><span class="token punctuation">,</span> launchParam_<span class="token punctuation">.</span>launchReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsRestoredInContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RestorePageStack</span><span class="token punctuation">(</span>want<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">OnSceneRestored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NotifyContinuationResult</span><span class="token punctuation">(</span>want<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldRecoverState</span><span class="token punctuation">(</span>want<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>string pageStack <span class="token operator">=</span> abilityRecovery_<span class="token operator">-&gt;</span><span class="token function">GetSavedPageStack</span><span class="token punctuation">(</span>AppExecFwk<span class="token double-colon punctuation">::</span>StateReason<span class="token double-colon punctuation">::</span>DEVELOPER_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        HandleScope <span class="token function">handleScope</span><span class="token punctuation">(</span>jsRuntime_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> env <span class="token operator">=</span> jsRuntime_<span class="token punctuation">.</span><span class="token function">GetNapiEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> mainWindow <span class="token operator">=</span> scene_<span class="token operator">-&gt;</span><span class="token function">GetMainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mainWindow <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mainWindow<span class="token operator">-&gt;</span><span class="token function">NapiSetUIContent</span><span class="token punctuation">(</span>pageStack<span class="token punctuation">,</span> env<span class="token punctuation">,</span> abilityContext_<span class="token operator">-&gt;</span><span class="token function">GetContentStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetNapiValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">TAG_LOGE</span><span class="token punctuation">(</span>AAFwkTag<span class="token double-colon punctuation">::</span>UIABILITY<span class="token punctuation">,</span> <span class="token string">&quot;MainWindow is nullptr.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">OnSceneRestored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">OnSceneCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,31),c=[e];function l(i,u){return s(),a("div",null,c)}const r=n(o,[["render",l],["__file","appRecovery.html.vue"]]);export{r as default};
